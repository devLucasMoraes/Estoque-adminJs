CREATE OR REPLACE FUNCTION atualiza_estoque_saidas() RETURNS TRIGGER AS $$
    DECLARE 
        contador integer;
		vlr_unt decimal;
        new_categorias_id integer;
        sum_qtd_em_estoque decimal;
        qtd_min decimal;
    BEGIN
		select materiais.valor_unt from materiais where id = new.material_id into vlr_unt;
		new.valor = vlr_unt * new.qtd;
        select categoria_id from materiais where id = new.material_id into new_categorias_id;
        select estoque_min from categorias where id = new_categorias_id into qtd_min;
        
        
        IF (TG_OP = 'DELETE') THEN
                UPDATE estoques SET 
                                    material_id = OLD.material_id, 
                                    qtd_em_estoque = qtd_em_estoque + OLD.qtd, 
                                    valor_total = (new.valor / new.qtd) * (qtd_em_estoque + OLD.qtd)
                WHERE material_id = OLD.material_id;
        ELSIF (TG_OP = 'UPDATE') THEN
                UPDATE estoques SET 
                                    material_id = new.material_id, 
                                    qtd_em_estoque = qtd_em_estoque - (new.qtd - old.qtd), 
                                    valor_total = (new.valor / new.qtd) * (qtd_em_estoque - (new.qtd - old.qtd)),
                                    categoria_id = new_categorias_id
                WHERE material_id = new.material_id;
        ELSIF (TG_OP = 'INSERT') THEN
            SELECT count(*) into contador FROM estoques WHERE material_id = new.material_id;
        
            IF contador > 0 THEN
                UPDATE estoques SET 
                                    material_id = new.material_id, 
                                    qtd_em_estoque = qtd_em_estoque - new.qtd, 
                                    valor_total = (new.valor / new.qtd) * (qtd_em_estoque - new.qtd),
                                    categoria_id = new_categorias_id
                WHERE material_id = new.material_id;
            ELSE
                INSERT INTO estoques (material_id, qtd_em_estoque, valor_total, "createdAt", "updatedAt", categoria_id)  
                VALUES (new.material_id, new.qtd * -1, new.valor * -1 ,CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, new_categorias_id);
            END IF;
            
            SELECT SUM(qtd_em_estoque) FROM estoques WHERE estoques.categoria_id = new_categorias_id into sum_qtd_em_estoque;
            
            IF (sum_qtd_em_estoque <= qtd_min) THEN
                UPDATE estoques SET abaixo_min = TRUE WHERE material_id = new.material_id;
                --UPDATE estoques SET valor_total = new_categorias_id WHERE material_id = new.material_id;
            ELSE 
                UPDATE estoques SET abaixo_min = FALSE WHERE material_id = new.material_id;
                --UPDATE estoques SET valor_total = new_categorias_id WHERE material_id = new.material_id;
            END IF;
        END IF;
        RETURN NEW;
    END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER t_atualiza_estoque_saidas
BEFORE INSERT OR UPDATE OR DELETE ON transacoes_saidas
FOR EACH ROW EXECUTE FUNCTION atualiza_estoque_saidas();

--select * from transacoes_saidas;
--SELECT * FROM estoques;